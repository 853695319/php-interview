#### 引擎

- InnoDB: 事务、行锁、聚簇索引
- MyISAM：表锁、非聚簇索引、无法安全恢复
- Memory: 基于内存、表锁、每行长度固定不支持blob\text
- Archive: 只支持select、insert
- Blackhole\CSV\Federated\merge\NDB

##### MyISAM 和 InnoDB 的区别

> 1. MyISAM 查询效率更高，但是不支持事物
> 2. InnoDB 插入、更新较高，支持事物处理
> 3. MyISAM 支持表锁， InnoDb 支持行锁
> 4. MyISAM 是默认引擎，InnoDB 需要指定
> 5. InnoDB 不支持 FULLTEXT 类型的索引

#### 锁

- 乐观锁： update table table_name set column_name = value, version=version+1 and where version = version;
- 悲观锁：update table table_name set column_name = value for update;
- 共享锁：读锁（S锁），就是多个事务对于同一数据可以共享一把锁，都能访问到数据，但是只能读不能修改 
- 排他锁：写锁（X锁），排他锁就是不能与其他锁并存，如一个事务获取了一个数据行的排他锁，其他事务就不能再获取该行的其他锁，包括共享锁和排他锁，但是获取排他锁的事务是可以对数据就行读取和修改。 

##### 什么是 MySQL 死锁？如何有效降低死锁？

> 死锁：死锁一般是事务相互等待对方资源，最后形成环路，而无法继续运行。
> 
> 产生死锁的原因：
> 
> 1. 系统资源不足；
> 2. 进程运行推进的顺序不合适；
> 3. 资源分配不当等；
> 
> 如何有效降低死锁：
> 
> 1. 按同一顺序访问资源；
> 2. 避免事务中的用户交互；
> 3. 保持事务简短并在一个批处理中；
> 4. 使用低隔离级别；
> 5. 使用绑定连接；

#### 避免死锁

- 如果不同程序会并发存取多个表，尽量约定以相同的顺序访问表，可以大大降低死锁机会
- 在同一个事务中，尽可能做到一次锁定所需要的所有资源，减少死锁产生概率；
- 对于非常容易产生死锁的业务部分，可以尝试使用升级锁定颗粒度，通过表级锁定来减少死锁产生的概率 
- 降低隔离级别。如果业务允许，将隔离级别调低也是较好的选择，比如将隔离级别从RR调整为RC，可以避免掉很多因为gap锁造成的死锁。 
- 为表添加合理的索引。可以看到如果不走索引将会为表的每一行记录添加上锁，死锁的概率大大增大 

#### 事务

如果一个数据库声称支持事务的操作，那么该数据库必须要具备以下四个特性： 

- 原子性（Atomicity）
- 一致性（Consistency）
- 隔离性（Isolation）
- 持久性（Durability）

以上是事务的四大特性(简称ACID)，其中事务的隔离性， 当多个线程都开启事务操作数据库中的数据时，数据库系统要能进行隔离操作， 以保证各个线程获取数据的准确性，如果不考虑事务的隔离性，会发生的几种问题：

- 脏读：一个事务内修改了数据，另一个事务读取并使用了这个数据；
- 幻读：一个事务内修改了涉及全表的数据，另一个事务往这个表里面插入了新的数据，第一个事务出现幻读；
- 不可重复读：一个事务内连续读了两次数据，中间另一个事务修改了这个数据，导致第一个事务前后两次读的数据不一致；
- 更新丢失：一个事务内变更了数据，另一个事务修改了这个数据，最后前一个事务commit导致另一个事务的变更丢失；

#### MySQL数据库为我们提供的四种隔离级别

- Read Uncommitted（读取未提交内容）
- Read Committed（读取提交内容）
- Repeatable Read（可重读）Mysql默认
- Serializable（可串行化）

| 隔离级别         | 脏读 | 不可重复读 | 幻读 |
| ---------------- | ---- | ---------- | ---- |
| Read Uncommitted | √    | √          | √    |
| Read Committed   | ×    | √          | √    |
| Repeatable Read  | ×    | ×          | √    |
| Serializable     | ×    | ×          | ×    |

##### 什么是 MySQL 的事物？事物都有那些特性？

> 事务是一个序列操作，其中的操作要么都执行，要么都不执行，它是一个不可分割的工作单位，ACID 四大特性是事务的基础。
> 
> -  **原子性**：一个事务（transaction）中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。
> - **一致性**：在事务开始之前和事务结束以后，数据库的完整性没有被破坏。
> - **隔离性**：数据库允许多个并发事务同时对其数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。
> - **持久性**：事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。

说起 MySQL 的事物，就会谈起并行事物而引发的问题，比如脏读、幻读和不可重复读。

##### 什么是脏读、幻读和不可重复读？会产生什么问题？该如何解决？

> - **脏读** ：脏读就是指当一个事务正在访问数据，并且对数据进行了修改，而这种修改还没有提交到数据库中，这时，另外一个事务也访问这个数据，然后使用了这个数据。
> - **不可重复读** ：是指在一个事务内，多次读同一数据。在这个事务还没有结束时，另外一个事务再修改数据。那么第一个事务两次读到的的数据可能是不一样的，因此称为是不可重复读。
> - **幻读**：当某事物正在执行插入或删除操作同时，第二个事物也在操作此表的数据，就会显示有一行还未存在的数据，就像发生了幻觉一样。
> 
> 解决办法：如果在操作事务完成数据处理之前，任何其他事务都不可以操作此数据，则可避免该问题。


#### 索引

##### 什么是索引，作用是什么？常见索引类型有那些？Mysql 建立索引的原则？

> 索引是一种特殊的文件,它们包含着对数据表里所有记录的引用指针，相当于书本的目录。其作用就是加快数据的检索效率。常见索引类型有主键、唯一索引、复合索引、全文索引。
> 
> - 索引创建的原则
>   - 最左前缀原理
>   - 尽量的去扩展索引，而不是重复的新建新索引

##### 建立表结构时添加的索引

- 主键唯一索引
- 唯一索引
- 普通索引
- 联合索引

##### 依据是否聚簇区分

- 聚簇索引
  + 引擎类型：InnoDB
  + 叶子结点存放数据本身
- 非聚簇索引 
  + 引擎类型：MyISAM
  + 叶子结点存的指针指向数据的实际地址，索引和数据分开
  
##### 索引底层数据结构

- hash索引 
  + 优点

    + 效率高，一次查找 时间复杂度O(1)

  + 缺点 

    + 只能进行=，<=>，in查询，无法进行范围查询 

      原因：对待查找的值进行hash算法，之后的hash值进行查找

    + 无法排序 

      原因：同上

    + 无法避免回表查找 

      原因：hash值和值的指针存放在hash表中

  + 低层实现 

    + hash表(散列表)

- b-tree索引

- b+tree索引

##### SQL 语句的优化方式？

> 1. 避免使用 Like 模糊查询
> 2. 只列出需要查询的字段，而不是所有
> 3. 不在 MySQL 中进行运算，减轻 MySQL 的压力
> 4. 经常查询的字段，创建合适的索引，提高查询效率

##### 数据库的优化方式？

> 1. 合理的设计表结构、表索引
> 2. 不在数据库中做运算
> 3. 控制单表数据量
> 4. 数据量过大进行读写分离，使用INNODB存储引擎
> 5. 不再数据表中存储图片

##### 什么是 MySQL 慢查询？又该如何优化？

> MySQL 中查询超过指定时间的语句，被称之为「慢查询」。该如何优化呢？优化 SQL 语句，创建合适的索引，如以上两个问题。

##### MySQL 分库分表怎么设计

> 1. 垂直分表
> 
> 垂直分表在日常开发和设计中比较常见，通俗的说法叫做“大表拆小表”，某个表中的字段比较多，可以新建立一张“扩展表”，将不经常使用或者长度较大的字段，拆分出去放到“扩展表”中。
> 
> 2. 垂直分库
> 
> 基本的思路就是按照业务模块来划分出不同的数据库，而不是像早期一样将所有的数据表都放到同一个数据库中。  
> 
> 3. 水平分表
> 
> 水平分表也称为横向分表，比较容易理解，就是将表中不同的数据行按照一定规律分布到不同的数据库表中（这些表保存在同一个数据库中），这样来降低单表数据量，优化查询性能。 
> 
> 4. 水平分库分表
> 
> 水平分库分表与上面讲到的水平分表的思想相同，唯一不同的就是将这些拆分出来的表保存在不同的数据库中。

#### 扩展阅读

- [MySQL索引原理及慢查询优化](https://tech.meituan.com/mysql-index.html)
- [分库分表的几种常见形式](http://www.infoq.com/cn/articles/key-steps-and-likely-problems-of-split-table)
- [大众点评订单系统分库分表实践](https://tech.meituan.com/dianping_order_db_sharding.html)
- [MySQL 死锁问题及解决](http://onwise.xyz/2017/04/20/mysql-%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3/)
- [MySQL索引背后的数据结构及算法原理](https://www.kancloud.cn/kancloud/theory-of-mysql-index/41846)
- [MySQL存储引擎InnoDB与Myisam的六大区别](https://my.oschina.net/junn/blog/183341)
- [『浅入深出』MySQL 中事务的实现](https://draveness.me/mysql-transaction#)
- [脏读、幻读和不可重复读](http://blog.sina.com.cn/s/blog_8020e4110101bfc6.html)